<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal do Candidato - Sistema de Vestibulares</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <style>
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px; height: 6px;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #a0aec0;
      border-radius: 3px;
    }
  </style>
</head>
<body class="bg-[#eaf2fa] font-sans text-[13px] text-[#000000]">

<!-- === LOGIN / CADASTRO === -->
<div id="authSection" class="flex h-screen justify-center items-center max-w-[1024px] mx-auto border border-gray-300 bg-white p-6">
  <div class="w-1/2 pr-6 border-r border-gray-300">
    <!-- Login -->
    <div id="loginForm">
      <h2 class="text-xl font-bold mb-4 select-text">Login do Candidato</h2>
      <input type="email" id="loginEmail" placeholder="E-mail" class="border px-3 py-2 mb-3 w-full rounded" />
      <input type="password" id="loginSenha" placeholder="Senha" class="border px-3 py-2 mb-3 w-full rounded" />
      <button onclick="fazerLogin()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full">Entrar</button>
      <p class="mt-4 text-sm select-text">Não tem conta? <span class="text-blue-600 cursor-pointer" onclick="toggleForms(true)">Criar conta</span></p>
    </div>
    <!-- Cadastro -->
    <div id="cadastroForm" style="display:none;">
      <h2 class="text-xl font-bold mb-4 select-text">Cadastro de Candidato</h2>
      <input type="text" id="cadNome" placeholder="Nome Completo" class="border px-3 py-2 mb-3 w-full rounded" />
      <input type="email" id="cadEmail" placeholder="E-mail" class="border px-3 py-2 mb-3 w-full rounded" />
      <input type="password" id="cadSenha" placeholder="Senha" class="border px-3 py-2 mb-3 w-full rounded" />
      <button onclick="cadastrar()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full">Cadastrar</button>
      <p class="mt-4 text-sm select-text">Já tem conta? <span class="text-blue-600 cursor-pointer" onclick="toggleForms(false)">Fazer login</span></p>
    </div>
  </div>
  <div class="w-1/2 pl-6">
    <h2 class="text-xl font-semibold mb-4 select-text">Novidades</h2>
    <div id="novidades" class="text-sm text-gray-700 select-text">Carregando novidades...</div>
  </div>
</div>

<!-- === DASHBOARD === -->
<div id="dashboardSection" class="hidden max-w-[1024px] mx-auto border border-gray-300 bg-white">
  <header class="flex items-center bg-[#d9e8fb] border-b border-gray-300 px-2 py-1 relative select-none">
    <div class="flex items-center gap-2">
      <img src="https://storage.googleapis.com/a1aa/image/ef63bc8a-156e-4c00-224e-44146b3a788e.jpg" width="60" height="60" alt="Logo" />
      <div class="text-[10px] leading-[1.1] text-[#a0a0a0] font-normal select-text">
        COMISSÃO<br />PERMANENTE<br />DE SELEÇÃO
      </div>
    </div>
    <h1 class="font-extrabold text-[16px] text-[#1f6e1f] ml-4 select-text">Ambiente de Desenvolvimento</h1>
    <div class="absolute right-2 top-1 flex items-center gap-3 text-[11px] font-normal text-black select-text">
      <span id="userName"></span>
      <button onclick="logout()" class="text-blue-700 hover:underline">Sair</button>
    </div>
  </header>

  <div class="flex min-h-[400px]">
    <!-- Menu lateral -->
    <nav
      aria-label="Portal do Candidato"
      class="w-[140px] border-r border-gray-300 bg-white text-[11px] text-[#000000] select-text"
    >
      <div class="border-b border-gray-300 px-2 py-1 font-bold select-text">Portal do Candidato</div>
      <ul class="px-2 py-1 space-y-1">
        <li><a href="#" id="menuInicio" class="block text-[#000000] hover:underline" onclick="mostrarTela('inicio')">Início</a></li>
        <li><a href="#" id="menuInscricao" class="block text-[#d40000] font-normal" onclick="mostrarTela('fazerInscricao')">Fazer Inscrição</a></li>
        <li><a href="#" id="menuConsultarInscricao" class="block text-[#000000] hover:underline" onclick="mostrarTela('consultarInscricao')">Consultar Inscrição</a></li>
        <li><a href="#" id="menuLocaisProva" class="block text-[#000000] hover:underline" onclick="mostrarTela('consultarLocais')">Consultar Locais de prova</a></li>
        <li><a href="#" id="menuDesempenho" class="block text-[#000000] hover:underline" onclick="mostrarTela('consultarDesempenho')">Consultar Desempenhos</a></li>
        <li><a href="#" class="block text-[#000000] hover:underline" onclick="logout()">Sair</a></li>
      </ul>
    </nav>

    <!-- Conteúdo principal -->
    <main class="flex-1 p-3 border-l border-gray-300 bg-white">
      <!-- Tela Início -->
      <section id="inicio" class="hidden select-text">
        <h2 class="text-lg font-semibold mb-2">Bem-vindo ao Portal do Candidato</h2>
        <p class="text-sm text-gray-600">Selecione uma opção no menu para continuar.</p>
      </section>

      <!-- Tela Fazer Inscrição -->
      <section id="fazerInscricao" class="hidden select-text">
        <h2 class="text-lg font-semibold mb-4">Fazer Inscrição</h2>

        <label for="vestibularSelect" class="block mb-2 font-semibold">Selecione o Vestibular</label>
        <select
          id="vestibularSelect"
          class="border border-gray-400 rounded px-2 py-1 mb-4 w-full max-w-[400px]"
          onchange="carregarCamposFormulario()"
        >
          <option value="">-- Selecione --</option>
        </select>

        <form id="formInscricao" class="space-y-3 max-w-[600px]" onsubmit="enviarInscricao(event)">
          <!-- Campos dinâmicos aqui -->
        </form>
      </section>

      <!-- Tela Consultar Inscrição -->
      <section id="consultarInscricao" class="hidden select-text">
        <h2 class="text-lg font-semibold mb-4">Consultar Inscrição</h2>
        <p>Funcionalidade futura</p>
      </section>

      <!-- Tela Consultar Locais de Prova -->
      <section id="consultarLocais" class="hidden select-text">
        <h2 class="text-lg font-semibold mb-4">Consultar Locais de Prova</h2>
        <p>Funcionalidade futura</p>
      </section>

      <!-- Tela Consultar Desempenhos -->
      <section id="consultarDesempenho" class="hidden select-text">
        <h2 class="text-lg font-semibold mb-4">Consultar Desempenhos</h2>
        <p>Funcionalidade futura</p>
      </section>
    </main>
  </div>
</div>

<script>
  // CONFIGURAÇÕES
  const API_KEY = '6855efa8bb5ccc0c9cf6d9ad';
  const URL_CANDIDATOS = 'https://vestibulares-302d.restdb.io/rest/candidatos';
  const URL_VESTIBULARES = 'https://vestibulares-302d.restdb.io/rest/vestibular';  
  const URL_FORMULARIOS = 'https://vestibulares-302d.restdb.io/rest/formcampos';
  const URL_INSCRICOES = 'https://vestibulares-302d.restdb.io/rest/inscricoes';

  let candidatoLogado = null;

  // Troca visibilidade dos formulários login/cadastro
  function toggleForms(cadastro) {
    document.getElementById('loginForm').style.display = cadastro ? 'none' : 'block';
    document.getElementById('cadastroForm').style.display = cadastro ? 'block' : 'none';
  }

  // CADASTRAR candidato
  function cadastrar() {
    const nome = document.getElementById('cadNome').value.trim();
    const email = document.getElementById('cadEmail').value.trim();
    const senha = document.getElementById('cadSenha').value.trim();

    if (!nome || !email || !senha) {
      alert('Preencha todos os campos para cadastro.');
      return;
    }

    fetch(URL_CANDIDATOS, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-apikey': API_KEY },
      body: JSON.stringify({ nome, email, senha })
    })
    .then(r => r.json())
    .then(data => {
      alert('Cadastro realizado com sucesso! Faça login agora.');
      toggleForms(false);
    })
    .catch(() => alert('Erro ao cadastrar.'));
  }

  // LOGIN candidato
  function fazerLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const senha = document.getElementById('loginSenha').value.trim();

    if (!email || !senha) {
      alert('Informe e-mail e senha para login.');
      return;
    }

    fetch(`${URL_CANDIDATOS}?q={"email":"${email}","senha":"${senha}"}`, {
      headers: { 'x-apikey': API_KEY }
    })
    .then(r => r.json())
    .then(data => {
      if (data.length === 0) {
        alert('Credenciais inválidas.');
        return;
      }
      candidatoLogado = data[0];
      iniciarDashboard();
    })
    .catch(() => alert('Erro ao fazer login.'));
  }

  // Inicializa dashboard após login
  function iniciarDashboard() {
    document.getElementById('authSection').style.display = 'none';
    document.getElementById('dashboardSection').style.display = 'block';
    document.getElementById('userName').innerText = candidatoLogado.nome;
    mostrarTela('inicio');
    carregarVestibulares();
  }

  // Mostrar a tela selecionada, esconder as outras
  function mostrarTela(telaId) {
    const telas = ['inicio', 'fazerInscricao', 'consultarInscricao', 'consultarLocais', 'consultarDesempenho'];
    telas.forEach(t => {
      document.getElementById(t).style.display = (t === telaId) ? 'block' : 'none';
    });
  }

  // Logout
  function logout() {
    candidatoLogado = null;
    document.getElementById('dashboardSection').style.display = 'none';
    document.getElementById('authSection').style.display = 'flex';
    clearFormInscricao();
  }

  // Carregar vestibulares para o combo box da inscrição
  function carregarVestibulares() {
    const sel = document.getElementById('vestibularSelect');
    sel.innerHTML = `<option value="">-- Selecione --</option>`;

    fetch(URL_VESTIBULARES, {
      headers: { 'x-apikey': API_KEY }
    })
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data) || data.length === 0) {
        sel.innerHTML += '<option disabled>Nenhum vestibular disponível</option>';
        return;
      }
      data.forEach(vest => {
        sel.innerHTML += `<option value="${vest._id}">${vest.nomeVestibular || vest.nome || 'Vestibular Sem Nome'}</option>`;
      });
    })
    .catch(() => {
      alert('Erro ao carregar vestibulares.');
    });
  }

  // Carregar campos do formulário para o vestibular selecionado
  function carregarCamposFormulario() {
    const vestibularId = document.getElementById('vestibularSelect').value;
    const form = document.getElementById('formInscricao');
    form.innerHTML = '';
    if (!vestibularId) return;

    fetch(`${URL_FORMULARIOS}?q={"vestibular_id":"${vestibularId}"}`, {
      headers: { 'x-apikey': API_KEY }
    })
    .then(r => r.json())
    .then(campos => {
      if (campos.length === 0) {
        form.innerHTML = '<p>Nenhum campo cadastrado para esse vestibular.</p>';
        return;
      }
      campos.forEach(campo => {
        let inputHtml = '';
        const idCampo = `campo_${campo._id}`;
        switch (campo.tipo) {
          case 'texto':
            inputHtml = `<input type="text" id="${idCampo}" name="${campo.nomeCampo}" class="border rounded px-2 py-1 w-full" required />`;
            break;
          case 'numero':
            inputHtml = `<input type="number" id="${idCampo}" name="${campo.nomeCampo}" class="border rounded px-2 py-1 w-full" required />`;
            break;
          case 'data':
            inputHtml = `<input type="date" id="${idCampo}" name="${campo.nomeCampo}" class="border rounded px-2 py-1 w-full" required />`;
            break;
          case 'email':
            inputHtml = `<input type="email" id="${idCampo}" name="${campo.nomeCampo}" class="border rounded px-2 py-1 w-full" required />`;
            break;
          case 'arquivo':
            inputHtml = `<input type="file" id="${idCampo}" name="${campo.nomeCampo}" class="border rounded px-2 py-1 w-full" />`;
            break;
          case 'textarea':
            inputHtml = `<textarea id="${idCampo}" name="${campo.nomeCampo}" rows="3" class="border rounded px-2 py-1 w-full" required></textarea>`;
            break;
          default:
            inputHtml = `<input type="text" id="${idCampo}" name="${campo.nomeCampo}" class="border rounded px-2 py-1 w-full" required />`;
        }
        form.innerHTML += `
          <div>
            <label for="${idCampo}" class="block mb-1 font-semibold">${campo.nomeCampo}</label>
            ${inputHtml}
          </div>
        `;
      });
      form.innerHTML += `<button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Enviar Inscrição</button>`;
    })
    .catch(() => {
      form.innerHTML = '<p>Erro ao carregar os campos do formulário.</p>';
    });
  }

  // Limpa form inscrição
  function clearFormInscricao() {
    const form = document.getElementById('formInscricao');
    form.innerHTML = '';
    document.getElementById('vestibularSelect').value = '';
  }

  // Enviar inscrição para o restdb com email e criado_em
  function enviarInscricao(event) {
    event.preventDefault();
    const vestibularId = document.getElementById('vestibularSelect').value;
    if (!vestibularId) {
      alert('Selecione um vestibular.');
      return;
    }

    if (!candidatoLogado || !candidatoLogado.email) {
      alert('Usuário não logado corretamente.');
      return;
    }

    const form = event.target;
    const dadosFormulario = {};
    
    for (let elem of form.elements) {
      if (!elem.name) continue;
      if (elem.type === 'file') {
        // Upload de arquivo não implementado, deixe vazio
        dadosFormulario[elem.name] = '';
      } else {
        dadosFormulario[elem.name] = elem.value;
      }
    }

    const dadosParaEnviar = {
      vestibular_id: vestibularId,
      dados: dadosFormulario,
      candidato_email: candidatoLogado.email, // campo com email do candidato logado
      criado_em: new Date().toISOString()
    };

    fetch(URL_INSCRICOES, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-apikey': API_KEY
      },
      body: JSON.stringify(dadosParaEnviar)
    })
    .then(response => {
      if (response.ok) {
        alert('Inscrição enviada com sucesso!');
        clearFormInscricao();
        mostrarTela('inicio');
      } else {
        alert('Erro ao enviar inscrição.');
      }
    })
    .catch(() => {
      alert('Erro ao enviar inscrição.');
    });
  }

  // Carregar novidades no login
  function carregarNovidades() {
    fetch('https://vestibulares-302d.restdb.io/rest/novidades', {
      headers: { 'x-apikey': API_KEY }
    })
    .then(r => r.json())
    .then(data => {
      const el = document.getElementById('novidades');
      if (data.length > 0) {
        el.innerText = data[0].mensagem || 'Nenhuma novidade cadastrada.';
      } else {
        el.innerText = 'Nenhuma novidade cadastrada.';
      }
    })
    .catch(() => {
      document.getElementById('novidades').innerText = 'Erro ao carregar novidades.';
    });
  }

  // Inicializa novidades ao carregar a página
  carregarNovidades();
</script>
</body>
</html>
